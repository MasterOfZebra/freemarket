# 🚀 Этапы 2-3: ML-адаптивный и семантический matching

## 📋 Анализ слабых мест после Этапа 1

### ⚠️ 1. Статичность системы (ручные веса)

**Проблема:**
- `category_weight` и `contextual_bonus` зафиксированы
- Возможен overfitting на текущем наборе категорий
- Не адаптируется под новые данные

**Решение:** Обучаемая модель (Logistic Regression / LightGBM)

---

### ⚠️ 2. Морфология без семантики

**Проблема:**
- pymorphy2 решает формы, но не смысл
- Пример: "пылесос" vs "робот-пылесос" — разные, но близкие по смыслу

**Решение:** Sentence embeddings для семантического сходства

---

### ⚠️ 3. Контекстные ключи ограничены

**Проблема:**
- Не различают "дополнительные" и "определяющие" слова
- "чехол для айфона" vs "айфон" имеют пересечение, но контекст различен

**Решение:** Контекстная фильтрация + semantic embeddings

---

### ⚠️ 4. Отсутствие адаптации к категориям

**Проблема:**
- Веса категорий статичны
- "байк" = "велосипед" в "спорте", но не в "мототехнике"

**Решение:** Category-specific synonym maps + feedback loop

---

### ⚠️ 5. Сбор данных без использования

**Проблема:**
- `TrainingDataCollector` собирает данные, но нет ML-модели
- Векторизация признаков не используется

**Решение:** Pipeline обучения и предсказания

---

### ⚠️ 6. Нет метрики качества на проде

**Проблема:**
- Метрики только из тестов
- Нет real-world feedback loop

**Решение:** Runtime статистика + регулярные отчёты

---

## 🤖 Этап 2 — ML-matching (адаптивное обучение)

**Цель:** Перейти от фиксированных весов к обучаемой модели.

**Срок:** 2-3 недели

**База:** Данные из `TrainingDataCollector` (100+ пар)

---

### 📦 Новые компоненты

| Модуль | Назначение | Статус |
|--------|-----------|--------|
| `backend/matching/train_model.py` | Обучение Logistic Regression / LightGBM | 📋 План |
| `backend/matching/model_predictor.py` | Предсказание вероятности совпадения | 📋 План |
| `backend/matching/feedback_manager.py` | Сбор пользовательских подтверждений | 📋 План |
| `backend/matching/threshold_tuner.py` | Оптимизация порога по F1-score | 📋 План |

---

### ⚙️ Архитектура пайплайна

```
┌──────────────────────────┐
│  TrainingDataCollector   │  ← собирает пары match/no_match
└──────────────┬───────────┘
               │
┌──────────────▼──────────────┐
│     FeatureCalculator       │  ← генерирует 8 признаков
└──────────────┬──────────────┘
               │
┌──────────────▼──────────────┐
│       TrainModel.py         │  ← Logistic Regression / LightGBM
└──────────────┬──────────────┘
               │
┌──────────────▼──────────────┐
│     ModelPredictor.py       │  ← прогноз match-probability
└─────────────────────────────┘
```

---

### 🔬 Вектор признаков (8 признаков)

| Признак | Описание | Диапазон |
|---------|----------|----------|
| `equivalence_score` | Rule-based эквивалентность | 0.0-1.0 |
| `language_similarity` | Языковое сходство | 0.0-1.0 |
| `category_match` | Совпадение категорий | 0.1-1.0 |
| `synonym_ratio` | Доля синонимичных слов | 0.0-1.0 |
| `word_order_penalty` | Штраф за порядок слов | 0.0-0.5 |
| `contextual_bonus` | Бонус контекста | 0.0-0.1 |
| `word_overlap` | Jaccard similarity | 0.0-1.0 |
| `text_length_diff` | Разница длин текстов | 0.0-1.0 |

---

### 📋 Мини-план по задачам (2-3 недели)

| № | Подзадача | Описание | Результат | Статус |
|---|-----------|----------|-----------|--------|
| 1️⃣ | Data preprocessing | Сбор ≥ 100 размеченных пар | CSV для обучения | 📋 План |
| 2️⃣ | Train logistic model | Scikit-learn, 8 признаков | `model.pkl` | 📋 План |
| 3️⃣ | Integrate predictor | EnhancedRuleBasedMatcher вызывает `model.predict()` | Score адаптивен | 📋 План |
| 4️⃣ | Threshold tuning | Оптимизация порога по F1-score | `auto-threshold` | 📋 План |
| 5️⃣ | Feedback loop | Сохранение результатов user feedback в JSONL | Непрерывное улучшение | 📋 План |
| 6️⃣ | Auto retrain | Cron/periodic retrain каждые 30 дней | Автообновление модели | 📋 План |

---

## 🧠 Этап 3 — Семантический matching (full ML)

**Цель:** Понимать смысл фраз, а не только слова.

**Срок:** 3-4 недели после стабилизации Этапа 2

**Инструменты:** SentenceTransformers, FAISS, HuggingFace

---

### 📦 Новые компоненты

| Модуль | Назначение | Статус |
|--------|-----------|--------|
| `backend/matching/semantic_index.py` | FAISS индекс для embeddings | 📋 План |
| `backend/matching/embedding_service.py` | Генерация sentence embeddings | 📋 План |
| `backend/matching/ensemble_scorer.py` | Комбинирование rule-based + ML + semantic | 📋 План |
| `backend/matching/contrastive_trainer.py` | Fine-tuning модели на парах | 📋 План |

---

### 📈 Итоговое направление

| Этап | Цель | Прирост | Статус |
|------|------|---------|--------|
| ✅ **Этап 1** | Rule-based ядро, морфология, контекст, категории | **+18-25%** | ✅ Завершён |
| 🟡 **Этап 2** | ML-matching (адаптивные веса, feedback) | **+30-40%** | 📋 План |
| 🔵 **Этап 3** | Семантический слой, embeddings, автообучение | **+10-15%** | 📋 План |

**Итоговая цель:** ~94-96% точность, ~90% recall, <3% ложных совпадений

